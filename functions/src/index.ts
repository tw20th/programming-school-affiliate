import { onSchedule } from 'firebase-functions/v2/scheduler'
import * as logger from 'firebase-functions/logger'
import { initializeApp } from 'firebase-admin/app'
import { getFirestore, Timestamp } from 'firebase-admin/firestore'
import OpenAI from 'openai'
import { OPENAI_API_KEY } from './secrets'
import { fetchImageByKeyword, UNSPLASH_ACCESS_KEY } from './unsplash'
import { postLatestToBuffer } from './buffer'

initializeApp()
const db = getFirestore()

export const scheduledAutoPost = onSchedule(
  {
    schedule: 'every day 09:00',
    secrets: [OPENAI_API_KEY, UNSPLASH_ACCESS_KEY],
  },
  async () => {
    logger.info('ğŸ“… è‡ªå‹•æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œé–‹å§‹')

    const todayDay = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][
      new Date().getDay()
    ]
    /**
     * Firestoreã‹ã‚‰æ›œæ—¥ã¨æœ€è¿‘ã®ä½¿ç”¨å±¥æ­´ã‚’è€ƒæ…®ã—ã¦ã€ä½¿ç”¨å¯èƒ½ãªãƒ©ãƒ³ãƒ€ãƒ ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿”ã™
     */
    async function getRandomKeyword(): Promise<string | null> {
      const keywordSnap = await db
        .collection('keywords')
        .where('active', '==', true)
        .get()

      if (keywordSnap.empty) {
        logger.warn('âš ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
        return null
      }

      const allKeywords = keywordSnap.docs
        .map((doc) => doc.data())
        .filter((k) => !k.days || k.days.includes(todayDay))

      const sevenDaysAgo = Timestamp.fromDate(
        new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
      )
      const recentSnap = await db
        .collection('posts')
        .where('createdAt', '>=', sevenDaysAgo)
        .where('autoGenerated', '==', true)
        .get()

      const recentKeywords = new Set<string>()
      recentSnap.docs.forEach((doc) => {
        const data = doc.data()
        if (data?.keyword) {
          recentKeywords.add(data.keyword)
        }
      })

      const filtered = allKeywords.filter((k) => !recentKeywords.has(k.keyword))
      if (filtered.length === 0) {
        logger.warn('âš ï¸ ä½¿ç”¨å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæœ€è¿‘ä½¿ç”¨æ¸ˆã¿ï¼‰')
        return null
      }

      const randomIndex = Math.floor(Math.random() * filtered.length)
      return filtered[randomIndex].keyword
    }

    const openai = new OpenAI({
      apiKey: OPENAI_API_KEY.value(),
    })

    const keyword = await getRandomKeyword()
    if (!keyword) return

    const prompt = `
ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã€‘
ã‚ãªãŸã¯38æ­³ã®å–¶æ¥­è·ã€å…±åƒãã§å­ã©ã‚‚ãŒ2äººã„ã‚‹ã¨ã„ã†è¨­å®šã®ã€Œå…±æ„Ÿã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ã§ã™ã€‚
èª­è€…ã¨åŒã˜ç›®ç·šãƒ»ç­‰èº«å¤§ã®èªã‚Šå£ã§ã€è‡ªåˆ†ã®ä½“é¨“ã‚’èªã‚ŠãªãŒã‚‰æ–‡ç« ã‚’ç¶´ã£ã¦ãã ã•ã„ã€‚

ã€ãƒ–ãƒ­ã‚°è¨˜äº‹ã®å‡ºåŠ›æ§‹é€ ã€‘
ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆé †ç•ªå³å®ˆãƒ»ãƒ©ãƒ™ãƒ«å³å®ˆï¼‰ï¼š

â–  ã‚¿ã‚¤ãƒˆãƒ«  
èª­è€…ã®å¿ƒã«å¼•ã£ã‹ã‹ã‚‹è‡ªç„¶ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã¦ãã ã•ã„

â–  ã‚«ãƒ†ã‚´ãƒª  
å‰¯æ¥­ï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’ï¼ä½“é¨“è«‡ï¼ã‚¹ã‚¯ãƒ¼ãƒ«é¸ã³ ãªã©é©åˆ‡ãªã‚«ãƒ†ã‚´ãƒªã‚’1ã¤

â–  æœ¬æ–‡ï¼ˆMarkdownï¼‰  
è¦‹å‡ºã—ï¼ˆ##ï¼‰ã€ãƒªã‚¹ãƒˆã€æ”¹è¡Œã‚’ä½¿ã£ã¦èª­ã¿ã‚„ã™ãæ›¸ã„ã¦ãã ã•ã„ã€‚  
å°å…¥ã¯æ„Ÿæƒ…ãƒ»å…±æ„Ÿã‹ã‚‰å…¥ã‚Šã€ä¸å®‰ã‚„æ‚©ã¿ â†’ è©¦è¡ŒéŒ¯èª¤ â†’ æ°—ã¥ã â†’ è»½ã„ãƒªãƒ³ã‚¯èª˜å° ã®æµã‚Œã§æ§‹æˆã—ã¦ãã ã•ã„ã€‚

â–  ã‚µãƒ ãƒç”»åƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰  
è‹±å˜èª3ã¤ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã€‚è¨˜äº‹ã®é›°å›²æ°—ãƒ»æ„Ÿæƒ…ã‚’åæ˜ ï¼ˆä¾‹: night, home, quietï¼‰

â–  ã‚¿ã‚°  
å‰¯æ¥­, ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°, å­è‚²ã¦, ä½“é¨“è«‡, æœªçµŒé¨“ ãªã©3ã€œ5å€‹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰

â–  æ¨å¥¨å†…éƒ¨ãƒªãƒ³ã‚¯  
ä¸‹è¨˜ã‹ã‚‰æœ€å¤§3ã¤é¸ã³ã€ã‚¹ãƒ©ãƒƒã‚°å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
/comparison  
/blog/choose-programming-school-5-tips  
/blog/sidejob-success-programming-school  
/blog/check-before-apply-programming-school  
/blog/school-failures-and-how-to-avoid  
/blog/programming-beginner-complete-guide

ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘
${keyword}

ã“ã®å½¢å¼ã«**å¿…ãš**å¾“ã£ã¦ãã ã•ã„ã€‚
    `

    const response = await openai.chat.completions.create({
      model: 'gpt-4',
      temperature: 0.7,
      messages: [
        {
          role: 'system',
          content:
            'ã‚ãªãŸã¯å…±æ„Ÿã‚’å¤§åˆ‡ã«ã™ã‚‹æ—¥æœ¬èªã®ãƒ–ãƒ­ã‚°ãƒ©ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚SEOã«ã‚‚å¼·ãã€Markdownå½¢å¼ã§è¨˜äº‹ã‚’æ›¸ãã¾ã™ã€‚',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
    })

    const raw = response.choices[0]?.message.content ?? ''
    logger.info('ğŸ§¾ OpenAIç”Ÿæˆçµæœ:', raw)

    const pattern =
      'â–  ã‚¿ã‚¤ãƒˆãƒ«\\s*(.+?)\\n+' +
      'â–  ã‚«ãƒ†ã‚´ãƒª\\s*(.+?)\\n+' +
      'â–  æœ¬æ–‡ï¼ˆMarkdownï¼‰\\s*([\\s\\S]+?)\\n+' +
      'â–  ã‚µãƒ ãƒç”»åƒã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰\\s*(.+?)\\n+' +
      'â–  ã‚¿ã‚°\\s*([\\s\\S]+?)\\n+' +
      'â–  æ¨å¥¨å†…éƒ¨ãƒªãƒ³ã‚¯\\s*([\\s\\S]+)$'

    const match = raw.match(new RegExp(pattern, 'i'))
    if (!match) {
      logger.error('âš ï¸ OpenAIå‡ºåŠ›ã®å½¢å¼ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™')
      return
    }

    const [, title, category, body, thumbnailKeywords, tagsRaw, linksRaw] =
      match

    const tags = tagsRaw
      .split(/,|\n|ãƒ»|ãƒ»/)
      .map((t) => t.trim())
      .filter(Boolean)

    const internalLinks = linksRaw
      .split(/\s|\n/)
      .map((l) => l.trim())
      .filter((l) => l.startsWith('/'))

    const now = new Date()
    const scheduled = new Date(now.getTime() + 24 * 60 * 60 * 1000)

    const image = await fetchImageByKeyword(thumbnailKeywords.trim())
    if (!image) {
      logger.warn('âš ï¸ ã‚µãƒ ãƒç”»åƒãŒå–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€ç©ºã§ä¿å­˜ã—ã¾ã™')
    }

    const post = {
      title: title.trim(),
      body: body.trim(),
      category: category.trim(),
      slug: generateSlug(title),
      tags,
      internalLinks,
      keyword,
      thumbnailUrl: image?.url ?? '',
      thumbnailAttribution: {
        photographer: image?.photographer ?? '',
        photographer_url: image?.photographer_url ?? '',
      },
      autoGenerated: true,
      variantId: 'A',
      testTarget: ['title'],
      clickCount: 0,
      readCount: 0,
      createdAt: Timestamp.fromDate(now),
      publishedAt: Timestamp.fromDate(scheduled),
    }

    await db.collection('posts').add(post)
    logger.info(`âœ… è‡ªå‹•æŠ•ç¨¿æˆåŠŸ: ${post.title}`)
  }
)

// ğŸ” â†ã“ã“ã§ scheduledAutoPost é–¢æ•°çµ‚äº†ï¼ã‚«ãƒƒã‚³ã®ä½ç½®ã«æ³¨æ„ï¼

// âœ… ã“ã£ã¡ã¯å®Œå…¨ã«åˆ¥ã®é–¢æ•°ã¨ã—ã¦ç‹¬ç«‹ã•ã›ã‚‹
export const scheduledPostToBuffer = onSchedule(
  {
    schedule: 'every day 09:10', // ãƒ–ãƒ­ã‚°æŠ•ç¨¿ã®ã‚ã¨ã«å®Ÿè¡Œ
    secrets: ['BUFFER_ACCESS_TOKEN', 'BUFFER_PROFILE_ID'],
  },
  async () => {
    await postLatestToBuffer()
  }
)

/**
 * ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLç”¨æ–‡å­—åˆ—ï¼‰ã‚’ç”Ÿæˆã™ã‚‹
 * @param {string} title ãƒ–ãƒ­ã‚°è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
 * @return {string} ã‚¹ãƒ©ãƒƒã‚°åŒ–ã•ã‚ŒãŸæ–‡å­—åˆ—ï¼ˆè‹±æ•°å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ï¼‰
 */
function generateSlug(title: string): string {
  return title
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
}
