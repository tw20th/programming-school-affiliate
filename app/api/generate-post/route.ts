import { NextResponse } from 'next/server'
import { generatePostByKeyword } from '@/lib/openai/generatePostByKeyword'
import { savePost } from '@/lib/firestore/savePost'
import { generateSlug } from '@/lib/utils/slug'

export async function POST(req: Request) {
  const { keyword } = await req.json()

  try {
    // OpenAIã§æŠ•ç¨¿ã‚’ç”Ÿæˆ
    const post = await generatePostByKeyword(keyword)

    // Firestoreã«ä¿å­˜
    await savePost({
      ...post,
      slug: generateSlug(post.title), // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ slug ç”Ÿæˆ
      keyword,
      thumbnailUrl: '',
      thumbnailAttribution: null,
      autoGenerated: true,
      createdAt: { seconds: Math.floor(Date.now() / 1000) },
      publishedAt: { seconds: Math.floor(Date.now() / 1000) },
      clickCount: 0,
      readCount: 0,
      variantId: '',
      testTarget: [],
      id: '', // Firestore å´ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹å ´åˆã¯ç©ºã§ã‚‚OK
    })

    return NextResponse.json(post)
  } catch (error) {
    console.error('ğŸ”¥ æŠ•ç¨¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error)
    return NextResponse.json(
      { error: (error as Error).message },
      { status: 500 }
    )
  }
}
